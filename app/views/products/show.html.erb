
<h1><%= @product._id %></h1>

<!-- show image -->
<%= image_tag(@product.image.url, :width => "300px", :height => "300px") %>
<br>

<!-- show date -->
<%= (@product.added_date + Time.zone_offset('IST')).strftime("%A,%d %B %Y") %>

<!-- show rating -->
<% if @product.avg_rating == -1 %>
<h2> Rating not available </h2>
<% else %>
<h2> <%= @product.avg_rating.round(1) %> </h2>
<% end %>



<!-- show reviews -->
<% if @product.reviews.size > 0 %>

<% for review in @product.reviews %>
<h3> author: <%= review.email %> </h3>
<p> date: <%= (review.review_date + Time.zone_offset('IST')).strftime("%A, %d %B %Y %H:%M:%S") %> </p>
<p> review: <%= review.body %> </p>
<p> rating: <%= review.rating %> </p>

<!-- show edit when user has review -->
<% if current_user %>
<% if review.email == current_user.email %>
<% @has_review = true %>
<% @curr_review = review %>

<%= link_to "Edit", {:controller => "products", :action => "show", :what => "edit" } %>
<%= link_to "Delete", {:controller => "products", :action => "show",:what =>"delete"}%>
<% end %>
<% end %> 
<% end %>

<% end %>

</br>

</br>

<!-- check if signed in -->
<% if user_signed_in? %>

<!-- check is parameter is edit -->
<% if params[:what]=="edit" %>
<p> Edit a review </p>

<% @review = @product.reviews.where(:email => current_user.email).one %>

<%= simple_form_for @review do |f| %>
<p> <%= f.label :body %> </p>
<p> <%= f.text_area :body %> </p>
<%= hidden_field_tag(:product_name, @product.product_name)%>
<p> <%= f.button :submit %>
<% end %>

<!-- check is parameter is delete -->
<% elsif params[:what]=="delete" and @has_review%>
<% @review = @product.reviews.where(:email => current_user.email).one %>
<% @lproduct  = Latest.one.latestproducts.where("product_name"=>@product.product_name).one %>

<% if @product.reviews.count== 1%>
<% @product.avg_rating = -1 %>
<% else %>
<% @product.avg_rating = ((@product.avg_rating * @product.reviews.count)-@review.rating)/(@product.reviews.count-1) %>
<% end %>

<% @lproduct.avg_rating = @product.avg_rating %>
<% @lproduct.save %>
<% @product.save %>

<% @review.destroy %>
<% @has_review=false %>
<% redirect_to :back %>

<% else %>

<!-- if user does not have a review, creat new one -->
<% if @has_review != true %> 
<p> write a review </p>

<%= form_for [@product, Review.new] do |f| %>
<p> <%= f.label :body %> <%= f.text_area :body %> </p>
<p> <%= f.submit %>
<% end %>

<% end %>

<% end %>

<!-- if not signed in -->
<% else %> 
<p> <%= link_to "Sign in", new_user_session_path %> to write review </p>
<% end %>
